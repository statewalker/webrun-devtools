<!DOCTYPE html>
<html>
  <head>
    <title>Titre de la page</title>
    <style>
      main {
        margin: auto;
        max-width: 1000px;
      }
      #screenshots {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1em;
      }
      #screenshots .screenshot {
        width: 100%;
        border: 1px solid gray;
      }

      #screenshots .label {
        text-align: center;
      }

      form .form-input {
        width: 500px;
        margin-bottom: 1em;
        align-content: stratch;
      }
      form .form-input label {
        display: flex;
        align-items: flex-start;
      }
      form .form-input label span {
       width: 12em; 
      }
      form .form-input label textarea {
        width: 100%;
      }

    </style>
  </head>
  <body>
    <main>
      <h1>Screen-Shooter</h1>
      <p>This page automatically creates screenshots of external sites.</p>
      <form>
        <div class="form-input">
          <label>
            <span>Sites URLs:</span>
            <textarea name="urls" id="urls" rows="10" columns="50"></textarea>
          </label>
        </div>
        <div class="form-input">
          <label>
            <span>Focus window:</span>
            <input type="checkbox" name="focus-window" id="focus-window" />
          </label>
        </div>
        <div class="form-input">
          <button id="btn-run">Make Screenshots</button>
        </div>
      </form>
      <div id="screenshots"></div>
    </main>
    <script type="module">
      import connectToExtension, { newRegistry } from "../dist/index.js";
     
      Promise.resolve().then(main).catch(console.error);

      async function main() {
        const initialUrls = [
          'https://svelte.dev/',
          'https://astro.build',
          'https://react.dev/',
          'https://www.solidjs.com/',
          'https://vuejs.org/',
          'https://webdriver.io/',
        ]

        let secret;
        const btn = document.querySelector("#btn-run");
        const focusCheckbox = document.querySelector("#focus-window");
        const textarea = document.querySelector("#urls");
        textarea.value = initialUrls.join('\n');
        btn.addEventListener("click", async (ev) => {
          ev.preventDefault();
          if (!secret) {
            secret = await prompt("Enter the debugger secret:", "SW_DEBUGGER_KEY_CHANGE_ME");
            if (!secret) {
              document.querySelector("#screenshots").innerHTML = "No secret provided. Reload the page to try again.";
              return;
            }
          }
          const focusWindow = !!focusCheckbox.checked;
          const urls = (textarea.value || '')
            .split('\n')
            .map(url => url.trim())
            .filter(Boolean);
          run({
            secret,
            urls,
            focusWindow
          });
        });
      }

      async function run({
        secret,
        urls,
        focusWindow
      }) {
        const [register, cleanup] = newRegistry();
        const api = await connectToExtension({ secret });
        try {
          const onCreated = (w) => {
            console.log('A window created', w);
          }
          api.windows.onCreated.addListener(onCreated);
          register(() => api.windows.onCreated.removeListener(onCreated));
          // register(await api.windows.onCreated(onCreated))

          const onRemoved = (w) => {
            console.log('A window removed', w);
          };
          api.windows.onRemoved.addListener(onRemoved);
          register(() => api.windows.onRemoved.removeListener(onRemoved));
          // register(await api.windows.onRemoved(onRemoved))

          const win = await api.windows.create({
            url : 'about:blank',
            focused : focusWindow,
            width : 800,
            height : 600
          });
          try {
            document.querySelector("#screenshots").innerHTML = "";
            const tab = win.tabs[0];
            // console.log('A tab created', tab);

            for (let url of urls) {
              await api.tabs.update(tab.id, { url, active: true });
              // MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND = 2
              // See https://developer.chrome.com/docs/extensions/reference/tabs/#property-MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND
              await new Promise(resolve => setTimeout(resolve, 600));
              await makeScreenshot(api, win.id, url);
            }
          } finally {
            await api.windows.remove(win.id);
            await new Promise(resolve => setTimeout(resolve, 300));
            cleanup();
          }
        } finally{
          await api.close();
        }
      }

      async function makeScreenshot(api, windowId, url) {
        const imgUrl = await api.tabs.captureVisibleTab(windowId, {
          format: "png"
        });

        const div = document.createElement('div');
        document.querySelector("#screenshots").appendChild(div);

        const img = document.createElement('img');
        img.src = imgUrl;
        img.className = 'screenshot';
        div.appendChild(img);
        const label = document.createElement('div');
        label.className = 'label';
        div.appendChild(label);

        const ref = document.createElement('a');
        ref.href = url;
        // ref.target = '_blank';
        ref.className = 'label';
        ref.innerText = url;  
        label.appendChild(ref);
      }
    </script>
  </body>
</html>